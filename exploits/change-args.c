#include <pthread.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/stat.h>
#include <unistd.h>

int done;
char path[] = "unchanged";

void *thread_proc(void* x) {
	printf("Press \"Enter\" to HAXX...\n");

	// Read a char from stdin.
	char in_char;
	read(STDIN_FILENO, &in_char, 1);

	// If read char is newline, change the path argument.
	if (in_char == 10) {
		strcpy(path, "changed");
		printf("done the thing\n");
	}

	pthread_exit(NULL);
}

void main() {
	int err;

	// Start the thread that will overwrite the argument string.
	pthread_t t1;
	err = pthread_create(&t1, NULL, thread_proc, NULL);
	if (err) {
		printf("error create %d\n", err);
	}

	// Remove residual directories from previous runs.
	rmdir("unchanged");
	rmdir("changed");

	// Call mkdir with the current value of the path argument.
	unsigned long syscall_nr = 83;
	unsigned long path_ptr = (unsigned long) &path;
	int mode = 777;
	syscall(syscall_nr, path, mode);

	// Print value of the path argument after completion.
	printf(path);
	printf("\n");

	// Check if path argument was changed before completion.
	struct stat statbuf;
	if (stat("changed", &statbuf) == 0) {
		printf("HAXXED!\n");
	} else {
		printf("Not haxxed :>\n");
	}

	// Cancel other thread and wait for it to exit.
	pthread_cancel(t1);
	err = pthread_join(t1, NULL);
	if (err) {
		printf("error join %d\n", err);
	}
}
